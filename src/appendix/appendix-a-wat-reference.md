# é™„å½•A å¸¸ç”¨ WAT æŒ‡ä»¤å‚è€ƒ

æœ¬é™„å½•æä¾› WebAssembly æ–‡æœ¬æ ¼å¼ (WAT) çš„å®Œæ•´æŒ‡ä»¤å‚è€ƒï¼ŒæŒ‰åŠŸèƒ½åˆ†ç±»æ•´ç†ï¼Œä¾¿äºå¼€å‘æ—¶å¿«é€ŸæŸ¥é˜…ã€‚

## A.1 æ¨¡å—ç»“æ„è¯­æ³•

### A.1.1 æ¨¡å—å®šä¹‰

```wat
(module
  ;; ç±»å‹å®šä¹‰
  (type $func_type (func (param i32) (result i32)))
  
  ;; å¯¼å…¥å£°æ˜
  (import "env" "memory" (memory 1))
  (import "console" "log" (func $log (param i32)))
  
  ;; å‡½æ•°å®šä¹‰
  (func $name (param $p1 i32) (result i32) ...)
  
  ;; è¡¨å®šä¹‰
  (table $table 10 funcref)
  
  ;; å†…å­˜å®šä¹‰
  (memory 1 2)
  
  ;; å…¨å±€å˜é‡
  (global $counter (mut i32) (i32.const 0))
  
  ;; å¯¼å‡ºå£°æ˜
  (export "function_name" (func $name))
  (export "memory" (memory 0))
  
  ;; èµ·å§‹å‡½æ•°
  (start $init)
  
  ;; å…ƒç´ æ®µï¼ˆåˆå§‹åŒ–è¡¨ï¼‰
  (elem (i32.const 0) $func1 $func2)
  
  ;; æ•°æ®æ®µï¼ˆåˆå§‹åŒ–å†…å­˜ï¼‰
  (data (i32.const 0) "Hello World"))
```

### A.1.2 å‡½æ•°å®šä¹‰è¯­æ³•

```wat
;; å®Œæ•´å½¢å¼
(func $name (param $arg1 i32) (param $arg2 f32) (result i64)
  (local $temp i32)
  ;; å‡½æ•°ä½“
  local.get $arg1
  i64.extend_i32_s)

;; ç®€åŒ–å½¢å¼
(func $name (param i32 f32) (result i64)
  ;; ä½¿ç”¨ç´¢å¼•è®¿é—®å‚æ•°ï¼šlocal.get 0, local.get 1
  local.get 0
  i64.extend_i32_s)

;; å¤šè¿”å›å€¼ï¼ˆWebAssembly 2.0+ï¼‰
(func $swap (param i32 i32) (result i32 i32)
  local.get 1
  local.get 0)
```

## A.2 æ•°æ®ç±»å‹å’Œå¸¸é‡

### A.2.1 åŸºæœ¬æ•°æ®ç±»å‹

| ç±»å‹ | æè¿° | å¤§å° | å–å€¼èŒƒå›´ |
|------|------|------|----------|
| `i32` | 32ä½æœ‰ç¬¦å·æ•´æ•° | 4å­—èŠ‚ | -2Â³Â¹ ~ 2Â³Â¹-1 |
| `i64` | 64ä½æœ‰ç¬¦å·æ•´æ•° | 8å­—èŠ‚ | -2â¶Â³ ~ 2â¶Â³-1 |
| `f32` | 32ä½æµ®ç‚¹æ•° | 4å­—èŠ‚ | IEEE 754 å•ç²¾åº¦ |
| `f64` | 64ä½æµ®ç‚¹æ•° | 8å­—èŠ‚ | IEEE 754 åŒç²¾åº¦ |
| `v128` | 128ä½å‘é‡ | 16å­—èŠ‚ | SIMD å‘é‡ç±»å‹ |
| `funcref` | å‡½æ•°å¼•ç”¨ | - | å‡½æ•°è¡¨ä¸­çš„å¼•ç”¨ |
| `externref` | å¤–éƒ¨å¼•ç”¨ | - | å®¿ä¸»ç¯å¢ƒå¯¹è±¡å¼•ç”¨ |

### A.2.2 å¸¸é‡å®šä¹‰

```wat
;; æ•´æ•°å¸¸é‡
i32.const 42              ;; åè¿›åˆ¶
i32.const 0x2A            ;; åå…­è¿›åˆ¶
i32.const 0o52            ;; å…«è¿›åˆ¶
i32.const 0b101010        ;; äºŒè¿›åˆ¶
i32.const -123            ;; è´Ÿæ•°

i64.const 1234567890123456789
i64.const 0x112210F47DE98115

;; æµ®ç‚¹æ•°å¸¸é‡
f32.const 3.14159         ;; æ ‡å‡†å½¢å¼
f32.const 1.23e-4         ;; ç§‘å­¦è®°æ•°æ³•
f32.const 0x1.921FB6p+1   ;; åå…­è¿›åˆ¶æµ®ç‚¹æ•°
f32.const inf             ;; æ­£æ— ç©·
f32.const -inf            ;; è´Ÿæ— ç©·
f32.const nan             ;; NaN
f32.const nan:0x400000    ;; å¸¦è½½è·çš„ NaN

f64.const 2.718281828459045
f64.const 0x1.5BF0A8B145769p+1
```

## A.3 ç®—æœ¯æŒ‡ä»¤

### A.3.1 æ•´æ•°ç®—æœ¯æŒ‡ä»¤

#### åŸºæœ¬ç®—æœ¯è¿ç®—

```wat
;; i32 ç®—æœ¯æŒ‡ä»¤
i32.add         ;; åŠ æ³•ï¼ša + b
i32.sub         ;; å‡æ³•ï¼ša - b  
i32.mul         ;; ä¹˜æ³•ï¼ša * b
i32.div_s       ;; æœ‰ç¬¦å·é™¤æ³•ï¼ša / b
i32.div_u       ;; æ— ç¬¦å·é™¤æ³•ï¼ša / b
i32.rem_s       ;; æœ‰ç¬¦å·å–ä½™ï¼ša % b
i32.rem_u       ;; æ— ç¬¦å·å–ä½™ï¼ša % b

;; i64 ç®—æœ¯æŒ‡ä»¤ï¼ˆåŒ i32ï¼‰
i64.add         i64.sub         i64.mul
i64.div_s       i64.div_u
i64.rem_s       i64.rem_u

;; ä¸€å…ƒè¿ç®—
i32.clz         ;; å‰å¯¼é›¶è®¡æ•°
i32.ctz         ;; åå¯¼é›¶è®¡æ•°
i32.popcnt      ;; ä½è®¡æ•°ï¼ˆæ±‰æ˜é‡é‡ï¼‰
i32.eqz         ;; ç­‰äºé›¶æµ‹è¯• (i32 â†’ i32)

i64.clz         i64.ctz         i64.popcnt      i64.eqz
```

#### ä½è¿ç®—æŒ‡ä»¤

```wat
;; æŒ‰ä½é€»è¾‘è¿ç®—
i32.and         ;; æŒ‰ä½ä¸ï¼ša & b
i32.or          ;; æŒ‰ä½æˆ–ï¼ša | b
i32.xor         ;; æŒ‰ä½å¼‚æˆ–ï¼ša ^ b

;; ç§»ä½è¿ç®—
i32.shl         ;; å·¦ç§»ï¼ša << b
i32.shr_s       ;; ç®—æœ¯å³ç§»ï¼ša >> b (ä¿æŒç¬¦å·)
i32.shr_u       ;; é€»è¾‘å³ç§»ï¼ša >>> b (è¡¥é›¶)
i32.rotl        ;; å¾ªç¯å·¦ç§»
i32.rotr        ;; å¾ªç¯å³ç§»

;; i64 ä½è¿ç®—ï¼ˆåŒ i32ï¼‰
i64.and         i64.or          i64.xor
i64.shl         i64.shr_s       i64.shr_u
i64.rotl        i64.rotr
```

### A.3.2 æµ®ç‚¹ç®—æœ¯æŒ‡ä»¤

```wat
;; f32/f64 åŸºæœ¬ç®—æœ¯
f32.add         f64.add         ;; åŠ æ³•
f32.sub         f64.sub         ;; å‡æ³•
f32.mul         f64.mul         ;; ä¹˜æ³•
f32.div         f64.div         ;; é™¤æ³•

;; æ•°å­¦å‡½æ•°
f32.abs         f64.abs         ;; ç»å¯¹å€¼
f32.neg         f64.neg         ;; å–è´Ÿ
f32.ceil        f64.ceil        ;; å‘ä¸Šå–æ•´
f32.floor       f64.floor       ;; å‘ä¸‹å–æ•´
f32.trunc       f64.trunc       ;; æˆªæ–­å–æ•´
f32.nearest     f64.nearest     ;; å››èˆäº”å…¥åˆ°æœ€è¿‘æ•´æ•°
f32.sqrt        f64.sqrt        ;; å¹³æ–¹æ ¹

;; æœ€å€¼è¿ç®—
f32.min         f64.min         ;; æœ€å°å€¼
f32.max         f64.max         ;; æœ€å¤§å€¼
f32.copysign    f64.copysign    ;; å¤åˆ¶ç¬¦å·ä½
```

## A.4 æ¯”è¾ƒæŒ‡ä»¤

### A.4.1 æ•´æ•°æ¯”è¾ƒ

```wat
;; i32 æ¯”è¾ƒæŒ‡ä»¤ï¼ˆè¿”å› i32ï¼š1 ä¸ºçœŸï¼Œ0 ä¸ºå‡ï¼‰
i32.eq          ;; ç›¸ç­‰ï¼ša == b
i32.ne          ;; ä¸ç­‰ï¼ša != b
i32.lt_s        ;; æœ‰ç¬¦å·å°äºï¼ša < b
i32.lt_u        ;; æ— ç¬¦å·å°äºï¼ša < b
i32.gt_s        ;; æœ‰ç¬¦å·å¤§äºï¼ša > b
i32.gt_u        ;; æ— ç¬¦å·å¤§äºï¼ša > b
i32.le_s        ;; æœ‰ç¬¦å·å°äºç­‰äºï¼ša <= b
i32.le_u        ;; æ— ç¬¦å·å°äºç­‰äºï¼ša <= b
i32.ge_s        ;; æœ‰ç¬¦å·å¤§äºç­‰äºï¼ša >= b
i32.ge_u        ;; æ— ç¬¦å·å¤§äºç­‰äºï¼ša >= b

;; i64 æ¯”è¾ƒæŒ‡ä»¤ï¼ˆåŒ i32ï¼‰
i64.eq          i64.ne
i64.lt_s        i64.lt_u        i64.gt_s        i64.gt_u
i64.le_s        i64.le_u        i64.ge_s        i64.ge_u
```

### A.4.2 æµ®ç‚¹æ¯”è¾ƒ

```wat
;; f32/f64 æ¯”è¾ƒæŒ‡ä»¤ï¼ˆè¿”å› i32ï¼‰
f32.eq          f64.eq          ;; ç›¸ç­‰
f32.ne          f64.ne          ;; ä¸ç­‰
f32.lt          f64.lt          ;; å°äº
f32.gt          f64.gt          ;; å¤§äº
f32.le          f64.le          ;; å°äºç­‰äº
f32.ge          f64.ge          ;; å¤§äºç­‰äº
```

## A.5 ç±»å‹è½¬æ¢æŒ‡ä»¤

### A.5.1 æ•´æ•°ç±»å‹è½¬æ¢

```wat
;; æ‰©å±•å’Œæˆªæ–­
i64.extend_i32_s        ;; i32 â†’ i64 (æœ‰ç¬¦å·æ‰©å±•)
i64.extend_i32_u        ;; i32 â†’ i64 (æ— ç¬¦å·æ‰©å±•)
i32.wrap_i64            ;; i64 â†’ i32 (æˆªæ–­ä½32ä½)

;; æˆªæ–­æ‰©å±•ï¼ˆç¬¦å·æ‰©å±•ï¼‰
i32.extend8_s           ;; i8 â†’ i32 (æœ‰ç¬¦å·æ‰©å±•)
i32.extend16_s          ;; i16 â†’ i32 (æœ‰ç¬¦å·æ‰©å±•)
i64.extend8_s           ;; i8 â†’ i64 (æœ‰ç¬¦å·æ‰©å±•)
i64.extend16_s          ;; i16 â†’ i64 (æœ‰ç¬¦å·æ‰©å±•)
i64.extend32_s          ;; i32 â†’ i64 (æœ‰ç¬¦å·æ‰©å±•)
```

### A.5.2 æµ®ç‚¹ç±»å‹è½¬æ¢

```wat
;; æµ®ç‚¹ç²¾åº¦è½¬æ¢
f64.promote_f32         ;; f32 â†’ f64 (æå‡ç²¾åº¦)
f32.demote_f64          ;; f64 â†’ f32 (é™ä½ç²¾åº¦)

;; æ•´æ•°ä¸æµ®ç‚¹æ•°è½¬æ¢
f32.convert_i32_s       ;; i32 â†’ f32 (æœ‰ç¬¦å·)
f32.convert_i32_u       ;; i32 â†’ f32 (æ— ç¬¦å·)
f32.convert_i64_s       ;; i64 â†’ f32 (æœ‰ç¬¦å·)
f32.convert_i64_u       ;; i64 â†’ f32 (æ— ç¬¦å·)
f64.convert_i32_s       ;; i32 â†’ f64 (æœ‰ç¬¦å·)
f64.convert_i32_u       ;; i32 â†’ f64 (æ— ç¬¦å·)
f64.convert_i64_s       ;; i64 â†’ f64 (æœ‰ç¬¦å·)
f64.convert_i64_u       ;; i64 â†’ f64 (æ— ç¬¦å·)

;; æµ®ç‚¹æ•°åˆ°æ•´æ•°è½¬æ¢
i32.trunc_f32_s         ;; f32 â†’ i32 (æœ‰ç¬¦å·æˆªæ–­)
i32.trunc_f32_u         ;; f32 â†’ i32 (æ— ç¬¦å·æˆªæ–­)
i32.trunc_f64_s         ;; f64 â†’ i32 (æœ‰ç¬¦å·æˆªæ–­)
i32.trunc_f64_u         ;; f64 â†’ i32 (æ— ç¬¦å·æˆªæ–­)
i64.trunc_f32_s         ;; f32 â†’ i64 (æœ‰ç¬¦å·æˆªæ–­)
i64.trunc_f32_u         ;; f32 â†’ i64 (æ— ç¬¦å·æˆªæ–­)
i64.trunc_f64_s         ;; f64 â†’ i64 (æœ‰ç¬¦å·æˆªæ–­)
i64.trunc_f64_u         ;; f64 â†’ i64 (æ— ç¬¦å·æˆªæ–­)

;; é¥±å’Œæˆªæ–­ï¼ˆé¿å…æº¢å‡ºå¼‚å¸¸ï¼‰
i32.trunc_sat_f32_s     ;; f32 â†’ i32 (æœ‰ç¬¦å·é¥±å’Œ)
i32.trunc_sat_f32_u     ;; f32 â†’ i32 (æ— ç¬¦å·é¥±å’Œ)
i32.trunc_sat_f64_s     ;; f64 â†’ i32 (æœ‰ç¬¦å·é¥±å’Œ)
i32.trunc_sat_f64_u     ;; f64 â†’ i32 (æ— ç¬¦å·é¥±å’Œ)
i64.trunc_sat_f32_s     ;; f32 â†’ i64 (æœ‰ç¬¦å·é¥±å’Œ)
i64.trunc_sat_f32_u     ;; f32 â†’ i64 (æ— ç¬¦å·é¥±å’Œ)
i64.trunc_sat_f64_s     ;; f64 â†’ i64 (æœ‰ç¬¦å·é¥±å’Œ)
i64.trunc_sat_f64_u     ;; f64 â†’ i64 (æ— ç¬¦å·é¥±å’Œ)
```

### A.5.3 é‡æ–°è§£é‡Šç±»å‹

```wat
;; ä½æ¨¡å¼é‡æ–°è§£é‡Šï¼ˆä¸æ”¹å˜ä½è¡¨ç¤ºï¼‰
i32.reinterpret_f32     ;; f32 â†’ i32 (ä½æ¨¡å¼è½¬æ¢)
i64.reinterpret_f64     ;; f64 â†’ i64 (ä½æ¨¡å¼è½¬æ¢)
f32.reinterpret_i32     ;; i32 â†’ f32 (ä½æ¨¡å¼è½¬æ¢)
f64.reinterpret_i64     ;; i64 â†’ f64 (ä½æ¨¡å¼è½¬æ¢)
```

## A.6 å±€éƒ¨å˜é‡å’Œæ ˆæ“ä½œ

### A.6.1 å±€éƒ¨å˜é‡æ“ä½œ

```wat
;; è·å–å±€éƒ¨å˜é‡/å‚æ•°
local.get $name         ;; æŒ‰åç§°è·å–
local.get 0             ;; æŒ‰ç´¢å¼•è·å–ï¼ˆ0æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰

;; è®¾ç½®å±€éƒ¨å˜é‡
local.set $name         ;; æŒ‰åç§°è®¾ç½®
local.set 0             ;; æŒ‰ç´¢å¼•è®¾ç½®

;; è®¾ç½®å¹¶è·å–å±€éƒ¨å˜é‡
local.tee $name         ;; è®¾ç½®å˜é‡å¹¶ä¿ç•™æ ˆé¡¶å€¼
local.tee 0             ;; æŒ‰ç´¢å¼•æ“ä½œ
```

### A.6.2 å…¨å±€å˜é‡æ“ä½œ

```wat
;; è·å–å…¨å±€å˜é‡
global.get $name        ;; æŒ‰åç§°è·å–
global.get 0            ;; æŒ‰ç´¢å¼•è·å–

;; è®¾ç½®å…¨å±€å˜é‡ï¼ˆä»…é™å¯å˜å…¨å±€å˜é‡ï¼‰
global.set $name        ;; æŒ‰åç§°è®¾ç½®
global.set 0            ;; æŒ‰ç´¢å¼•è®¾ç½®
```

### A.6.3 æ ˆæ“ä½œæŒ‡ä»¤

```wat
drop                    ;; ä¸¢å¼ƒæ ˆé¡¶å€¼
select                  ;; æ¡ä»¶é€‰æ‹©ï¼šcondition ? a : b
                        ;; æ ˆï¼š[condition] [false_val] [true_val] â†’ [result]
```

## A.7 æ§åˆ¶æµæŒ‡ä»¤

### A.7.1 åŸºæœ¬æ§åˆ¶ç»“æ„

```wat
;; æ— æ¡ä»¶å—
(block $label
  ;; ä»£ç å—
  br $label)            ;; è·³å‡ºå—

;; å¾ªç¯å—
(loop $label
  ;; å¾ªç¯ä½“
  br $label)            ;; è·³å›å¾ªç¯å¼€å§‹

;; æ¡ä»¶åˆ†æ”¯
(if (result i32)        ;; å¯é€‰è¿”å›ç±»å‹
  ;; æ¡ä»¶è¡¨è¾¾å¼
  (then
    ;; then åˆ†æ”¯)
  (else
    ;; else åˆ†æ”¯))        ;; else åˆ†æ”¯å¯é€‰
```

### A.7.2 è·³è½¬æŒ‡ä»¤

```wat
br $label               ;; æ— æ¡ä»¶è·³è½¬åˆ°æ ‡ç­¾
br_if $label            ;; æ¡ä»¶è·³è½¬ï¼šå¦‚æœæ ˆé¡¶éé›¶åˆ™è·³è½¬
br_table $l1 $l2 $default   ;; è¡¨è·³è½¬ï¼ˆswitch è¯­å¥ï¼‰
return                  ;; å‡½æ•°è¿”å›
unreachable             ;; æ ‡è®°ä¸å¯è¾¾ä»£ç ï¼ˆè§¦å‘ trapï¼‰
```

### A.7.3 å‡½æ•°è°ƒç”¨

```wat
call $function_name     ;; ç›´æ¥å‡½æ•°è°ƒç”¨
call_indirect (type $sig) $table   ;; é—´æ¥å‡½æ•°è°ƒç”¨ï¼ˆé€šè¿‡å‡½æ•°è¡¨ï¼‰
```

## A.8 å†…å­˜æ“ä½œæŒ‡ä»¤

### A.8.1 å†…å­˜åŠ è½½æŒ‡ä»¤

```wat
;; åŸºæœ¬åŠ è½½æŒ‡ä»¤
i32.load                ;; åŠ è½½32ä½æ•´æ•°
i64.load                ;; åŠ è½½64ä½æ•´æ•°  
f32.load                ;; åŠ è½½32ä½æµ®ç‚¹æ•°
f64.load                ;; åŠ è½½64ä½æµ®ç‚¹æ•°

;; å¸¦åç§»å’Œå¯¹é½çš„åŠ è½½
i32.load offset=4 align=4
i64.load offset=8 align=8

;; éƒ¨åˆ†åŠ è½½ï¼ˆæ‰©å±•ï¼‰
i32.load8_s             ;; åŠ è½½8ä½æœ‰ç¬¦å·æ‰©å±•åˆ°32ä½
i32.load8_u             ;; åŠ è½½8ä½æ— ç¬¦å·æ‰©å±•åˆ°32ä½
i32.load16_s            ;; åŠ è½½16ä½æœ‰ç¬¦å·æ‰©å±•åˆ°32ä½
i32.load16_u            ;; åŠ è½½16ä½æ— ç¬¦å·æ‰©å±•åˆ°32ä½
i64.load8_s             ;; åŠ è½½8ä½æœ‰ç¬¦å·æ‰©å±•åˆ°64ä½
i64.load8_u             ;; åŠ è½½8ä½æ— ç¬¦å·æ‰©å±•åˆ°64ä½
i64.load16_s            ;; åŠ è½½16ä½æœ‰ç¬¦å·æ‰©å±•åˆ°64ä½
i64.load16_u            ;; åŠ è½½16ä½æ— ç¬¦å·æ‰©å±•åˆ°64ä½
i64.load32_s            ;; åŠ è½½32ä½æœ‰ç¬¦å·æ‰©å±•åˆ°64ä½
i64.load32_u            ;; åŠ è½½32ä½æ— ç¬¦å·æ‰©å±•åˆ°64ä½
```

### A.8.2 å†…å­˜å­˜å‚¨æŒ‡ä»¤

```wat
;; åŸºæœ¬å­˜å‚¨æŒ‡ä»¤
i32.store               ;; å­˜å‚¨32ä½æ•´æ•°
i64.store               ;; å­˜å‚¨64ä½æ•´æ•°
f32.store               ;; å­˜å‚¨32ä½æµ®ç‚¹æ•°
f64.store               ;; å­˜å‚¨64ä½æµ®ç‚¹æ•°

;; å¸¦åç§»å’Œå¯¹é½çš„å­˜å‚¨
i32.store offset=4 align=4
i64.store offset=8 align=8

;; éƒ¨åˆ†å­˜å‚¨ï¼ˆæˆªæ–­ï¼‰
i32.store8              ;; å­˜å‚¨32ä½æ•´æ•°çš„ä½8ä½
i32.store16             ;; å­˜å‚¨32ä½æ•´æ•°çš„ä½16ä½
i64.store8              ;; å­˜å‚¨64ä½æ•´æ•°çš„ä½8ä½
i64.store16             ;; å­˜å‚¨64ä½æ•´æ•°çš„ä½16ä½
i64.store32             ;; å­˜å‚¨64ä½æ•´æ•°çš„ä½32ä½
```

### A.8.3 å†…å­˜ç®¡ç†æŒ‡ä»¤

```wat
memory.size             ;; è·å–å†…å­˜å¤§å°ï¼ˆä»¥é¡µä¸ºå•ä½ï¼Œ1é¡µ=64KBï¼‰
memory.grow             ;; å¢é•¿å†…å­˜å¤§å°ï¼Œè¿”å›ä¹‹å‰çš„å¤§å°

;; æ‰¹é‡å†…å­˜æ“ä½œï¼ˆbulk memory operationsï¼‰
memory.init $data_segment    ;; ä»æ•°æ®æ®µåˆå§‹åŒ–å†…å­˜
data.drop $data_segment      ;; ä¸¢å¼ƒæ•°æ®æ®µ
memory.copy                  ;; å¤åˆ¶å†…å­˜åŒºåŸŸ  
memory.fill                  ;; å¡«å……å†…å­˜åŒºåŸŸ
```

## A.9 è¡¨æ“ä½œæŒ‡ä»¤

### A.9.1 åŸºæœ¬è¡¨æ“ä½œ

```wat
table.get $table        ;; è·å–è¡¨å…ƒç´ 
table.set $table        ;; è®¾ç½®è¡¨å…ƒç´ 
table.size $table       ;; è·å–è¡¨å¤§å°
table.grow $table       ;; å¢é•¿è¡¨å¤§å°
table.fill $table       ;; å¡«å……è¡¨
table.copy $dest $src   ;; å¤åˆ¶è¡¨å…ƒç´ 
table.init $table $elem ;; ä»å…ƒç´ æ®µåˆå§‹åŒ–è¡¨
elem.drop $elem         ;; ä¸¢å¼ƒå…ƒç´ æ®µ
```

## A.10 åŸå­æ“ä½œæŒ‡ä»¤ï¼ˆçº¿ç¨‹æ‰©å±•ï¼‰

### A.10.1 åŸå­å†…å­˜æ“ä½œ

```wat
;; åŸå­åŠ è½½/å­˜å‚¨
i32.atomic.load         ;; åŸå­åŠ è½½32ä½
i64.atomic.load         ;; åŸå­åŠ è½½64ä½
i32.atomic.store        ;; åŸå­å­˜å‚¨32ä½
i64.atomic.store        ;; åŸå­å­˜å‚¨64ä½

;; è¯»-ä¿®æ”¹-å†™æ“ä½œ
i32.atomic.rmw.add      ;; åŸå­åŠ æ³•
i32.atomic.rmw.sub      ;; åŸå­å‡æ³•
i32.atomic.rmw.and      ;; åŸå­ä¸è¿ç®—
i32.atomic.rmw.or       ;; åŸå­æˆ–è¿ç®—
i32.atomic.rmw.xor      ;; åŸå­å¼‚æˆ–è¿ç®—
i32.atomic.rmw.xchg     ;; åŸå­äº¤æ¢

;; æ¯”è¾ƒå¹¶äº¤æ¢
i32.atomic.rmw.cmpxchg  ;; åŸå­æ¯”è¾ƒå¹¶äº¤æ¢

;; å†…å­˜å±éšœ
memory.atomic.notify    ;; é€šçŸ¥ç­‰å¾…çº¿ç¨‹
memory.atomic.wait32    ;; ç­‰å¾…32ä½å€¼å˜åŒ–
memory.atomic.wait64    ;; ç­‰å¾…64ä½å€¼å˜åŒ–
atomic.fence            ;; å†…å­˜å±éšœ
```

## A.11 SIMD æŒ‡ä»¤ï¼ˆå‘é‡æ‰©å±•ï¼‰

### A.11.1 å‘é‡æ“ä½œ

```wat
;; v128 ç±»å‹å¸¸é‡
v128.const i32x4 1 2 3 4        ;; åˆ›å»º4ä¸ªi32å‘é‡
v128.const f32x4 1.0 2.0 3.0 4.0 ;; åˆ›å»º4ä¸ªf32å‘é‡

;; å‘é‡åŠ è½½/å­˜å‚¨
v128.load                       ;; åŠ è½½128ä½å‘é‡
v128.load8x8_s                  ;; åŠ è½½8ä¸ªi8ï¼Œæ‰©å±•åˆ°i16
v128.load16x4_s                 ;; åŠ è½½4ä¸ªi16ï¼Œæ‰©å±•åˆ°i32
v128.load32x2_s                 ;; åŠ è½½2ä¸ªi32ï¼Œæ‰©å±•åˆ°i64
v128.store                      ;; å­˜å‚¨128ä½å‘é‡

;; å‘é‡ç®—æœ¯è¿ç®—
i32x4.add                       ;; 4ä¸ªi32å¹¶è¡ŒåŠ æ³•
i32x4.sub                       ;; 4ä¸ªi32å¹¶è¡Œå‡æ³•
i32x4.mul                       ;; 4ä¸ªi32å¹¶è¡Œä¹˜æ³•
f32x4.add                       ;; 4ä¸ªf32å¹¶è¡ŒåŠ æ³•
f32x4.sqrt                      ;; 4ä¸ªf32å¹¶è¡Œå¹³æ–¹æ ¹

;; å‘é‡æ¯”è¾ƒ
i32x4.eq                        ;; 4ä¸ªi32å¹¶è¡Œç›¸ç­‰æ¯”è¾ƒ
f32x4.lt                        ;; 4ä¸ªf32å¹¶è¡Œå°äºæ¯”è¾ƒ

;; å‘é‡é€‰æ‹©å’Œæ··åˆ
v128.bitselect                  ;; æŒ‰ä½é€‰æ‹©
i8x16.shuffle                   ;; å­—èŠ‚shuffleé‡æ’
```

## A.12 å¼‚å¸¸å¤„ç†æŒ‡ä»¤ï¼ˆå¼‚å¸¸æ‰©å±•ï¼‰

### A.12.1 å¼‚å¸¸æ“ä½œ

```wat
;; å¼‚å¸¸æ ‡ç­¾å®šä¹‰
(tag $my_exception (param i32))

;; å¼‚å¸¸å¤„ç†å—
(try (result i32)
  ;; å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç 
  (throw $my_exception (i32.const 42))
  (catch $my_exception
    ;; å¼‚å¸¸å¤„ç†ä»£ç 
    drop    ;; ä¸¢å¼ƒå¼‚å¸¸å‚æ•°
    i32.const -1))

;; å¼‚å¸¸æŒ‡ä»¤
throw $tag                      ;; æŠ›å‡ºå¼‚å¸¸
rethrow $label                  ;; é‡æ–°æŠ›å‡ºå¼‚å¸¸
```

## A.13 å¸¸ç”¨ä»£ç æ¨¡å¼

### A.13.1 æ¡ä»¶è¡¨è¾¾å¼æ¨¡å¼

```wat
;; ä¸‰å…ƒè¿ç®—ç¬¦æ¨¡å¼
(if (result i32)
  ;; æ¡ä»¶
  (then ;; çœŸå€¼)
  (else ;; å‡å€¼))

;; ä½¿ç”¨ select çš„ç®€åŒ–ç‰ˆæœ¬
(select
  ;; çœŸå€¼
  ;; å‡å€¼
  ;; æ¡ä»¶)
```

### A.13.2 å¾ªç¯æ¨¡å¼

```wat
;; è®¡æ•°å¾ªç¯
(local $i i32)
(local.set $i (i32.const 0))
(loop $loop
  ;; å¾ªç¯ä½“
  
  ;; é€’å¢è®¡æ•°å™¨
  (local.set $i (i32.add (local.get $i) (i32.const 1)))
  
  ;; æ¡ä»¶æ£€æŸ¥
  (br_if $loop (i32.lt_s (local.get $i) (i32.const 10))))

;; while å¾ªç¯æ¨¡å¼
(loop $while
  (if (;; æ¡ä»¶)
    (then
      ;; å¾ªç¯ä½“
      (br $while))))

;; do-while å¾ªç¯æ¨¡å¼
(loop $do_while
  ;; å¾ªç¯ä½“
  
  (br_if $do_while (;; æ¡ä»¶)))
```

### A.13.3 å‡½æ•°æŒ‡é’ˆå’Œå›è°ƒæ¨¡å¼

```wat
;; å®šä¹‰å‡½æ•°ç±»å‹
(type $callback (func (param i32) (result i32)))

;; å‡½æ•°è¡¨
(table $callbacks 10 funcref)

;; å›è°ƒè°ƒç”¨
(func $call_callback (param $index i32) (param $value i32) (result i32)
  (call_indirect (type $callback)
    (local.get $value)
    (local.get $index)))
```

### A.13.4 é”™è¯¯å¤„ç†æ¨¡å¼

```wat
;; è¿”å›é”™è¯¯ç 
(func $safe_divide (param $a i32) (param $b i32) (result i32)
  (if (result i32)
    (i32.eqz (local.get $b))
    (then (i32.const -1))  ;; é”™è¯¯ç 
    (else (i32.div_s (local.get $a) (local.get $b)))))

;; ä½¿ç”¨å…¨å±€é”™è¯¯æ ‡å¿—
(global $error_flag (mut i32) (i32.const 0))

(func $operation_with_error_flag
  ;; é‡ç½®é”™è¯¯æ ‡å¿—
  (global.set $error_flag (i32.const 0))
  
  ;; æ“ä½œ...
  ;; å¦‚æœå‡ºé”™
  (global.set $error_flag (i32.const 1)))
```

## A.14 æ€§èƒ½ä¼˜åŒ–æç¤º

### A.14.1 æŒ‡ä»¤é€‰æ‹©ä¼˜åŒ–

```wat
;; ä¼˜å…ˆä½¿ç”¨é«˜æ•ˆæŒ‡ä»¤
;; å¥½ï¼šä½¿ç”¨ç§»ä½ä»£æ›¿ä¹˜æ³•/é™¤æ³•ï¼ˆå½“å¯èƒ½æ—¶ï¼‰
(i32.shl (local.get $x) (i32.const 3))  ;; x * 8

;; é¿å…ï¼š
(i32.mul (local.get $x) (i32.const 8))

;; å¥½ï¼šä½¿ç”¨ä½è¿ç®—æ£€æŸ¥å¥‡å¶
(i32.and (local.get $x) (i32.const 1))  ;; x % 2

;; é¿å…ï¼š
(i32.rem_s (local.get $x) (i32.const 2))
```

### A.14.2 å†…å­˜è®¿é—®ä¼˜åŒ–

```wat
;; å¥½ï¼šæŒ‰å¯¹é½è¾¹ç•Œè®¿é—®
i32.load align=4        ;; 4å­—èŠ‚å¯¹é½
i64.load align=8        ;; 8å­—èŠ‚å¯¹é½

;; é¿å…ï¼šæœªå¯¹é½è®¿é—®
i32.load align=1        ;; å¯èƒ½è¾ƒæ…¢

;; å¥½ï¼šæ‰¹é‡æ“ä½œ
memory.copy             ;; æ¯”å¾ªç¯å¤åˆ¶æ›´å¿«
memory.fill             ;; æ¯”å¾ªç¯å¡«å……æ›´å¿«
```

### A.14.3 æ§åˆ¶æµä¼˜åŒ–

```wat
;; å¥½ï¼šå‡å°‘è·³è½¬
(if (local.get $condition)
  (then
    ;; ç›´æ¥è®¡ç®—))

;; é¿å…ï¼šè¿‡å¤šåµŒå¥—
(if (local.get $a)
  (then
    (if (local.get $b)
      (then
        (if (local.get $c)
          ;; è¿‡åº¦åµŒå¥—)))))
```

## A.15 è°ƒè¯•å’Œå¼€å‘æŠ€å·§

### A.15.1 è°ƒè¯•è¾…åŠ©æ¨¡å¼

```wat
;; ä½¿ç”¨ unreachable æ ‡è®°é”™è¯¯è·¯å¾„
(if (i32.lt_s (local.get $index) (i32.const 0))
  (then
    unreachable))  ;; è§¦å‘ trapï¼Œä¾¿äºè°ƒè¯•

;; ä½¿ç”¨å¯¼å…¥å‡½æ•°è¿›è¡Œè°ƒè¯•è¾“å‡º
(import "debug" "log_i32" (func $log (param i32)))

(func $debug_example (param $value i32)
  ;; è®°å½•å‚æ•°å€¼
  (call $log (local.get $value))
  
  ;; ç»§ç»­å¤„ç†...)
```

### A.15.2 ä»£ç ç»„ç»‡å»ºè®®

```wat
;; ä½¿ç”¨æœ‰æ„ä¹‰çš„å‡½æ•°å’Œå˜é‡å
(func $calculate_fibonacci (param $n i32) (result i32)
  (local $prev i32)
  (local $curr i32)
  ;; æ¸…æ™°çš„å®ç°)

;; æ·»åŠ æ³¨é‡Šè¯´æ˜å¤æ‚é€»è¾‘
;; è®¡ç®— x çš„å¹³æ–¹æ ¹ï¼ˆç‰›é¡¿æ³•ï¼‰
(func $sqrt_newton (param $x f64) (result f64)
  ;; å®ç°...)

;; å°†ç›¸å…³åŠŸèƒ½åˆ†ç»„åˆ°åŒä¸€æ¨¡å—
(module
  ;; æ•°å­¦å‡½æ•°ç»„
  (func $add ...)
  (func $multiply ...)
  (func $power ...)
  
  ;; å­—ç¬¦ä¸²å¤„ç†ç»„
  (func $strlen ...)
  (func $strcmp ...)
  (func $strcpy ...))
```

---

**ğŸ“– å‚è€ƒè¯´æ˜**ï¼š
- æ‰€æœ‰æŒ‡ä»¤éƒ½åŒºåˆ†å¤§å°å†™
- æ ‡ç­¾åï¼ˆå¦‚ `$name`ï¼‰æ˜¯å¯é€‰çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ•°å­—ç´¢å¼•
- æŸäº›é«˜çº§æŒ‡ä»¤éœ€è¦ç‰¹å®šçš„ WebAssembly ææ¡ˆæ”¯æŒ
- æ€§èƒ½ç‰¹æ€§å¯èƒ½å› ä¸åŒçš„ WebAssembly è¿è¡Œæ—¶è€Œå¼‚

**ğŸ”— ç›¸å…³ç« èŠ‚**ï¼š
- [ç¬¬4ç«  WebAssembly æ–‡æœ¬æ ¼å¼ (WAT)](../part2/chapter4-wat.md)
- [ç¬¬5ç«  å†…å­˜ç®¡ç†](../part2/chapter5-memory.md)
- [ç¬¬6ç«  æ§åˆ¶æµ](../part2/chapter6-control-flow.md)
